<?php
/******************************************************************
 *   SCRIPT PHP
 *
 ******************************************************************
 *
 * int $categoria: la categoria che si sta visitando
 * int $pagina: la pagina corrente all'interno della categoria
 * int $n: numero di quadri per pagina
 * string $lang: ita | eng
 *
 * Perchè la pagina possa essere visualizzata in più lingue sono
 * necessari alcuni elementi per la localizzazione. Prima dello
 * script vero e proprio ci sono i testi da tradurre nelle varie linugue.
 * Come nel resto del sito, la linugua è indicata da 3 caratteri
 * per esempio ita, eng, fra...
 * I testi localizzati sono nell'array bidimensionale
 * $testo[$lang][$z];
 * dove $z è il codice del messaggio
 *
 *****************************************************************/
require 'include/config.php';

$testo["ita"][1] = 'Galleria';
$testo["eng"][1] = 'Gallery';
$testo["ita"][2] = '<h2>Pagina %d di %d</h2>';
$testo["eng"][2] = '<h2>Page %d of %d</h2>';
$testo["ita"][3] = 'Le immagini nella galleria sono divise per categorie.
	Per scegliere un\' altra categoria clicca su "Galleria" a sinistra.';
$testo["eng"][3] = 'The pictures are grouped by their context. To visit
	another section please use the "Gallery" button on the left.';
$testo["ita"][4] = 'Ci sono %s opere';
$testo["eng"][4] = 'Contains %s pictures';
$testo["ita"][5] = 'Sito in allestimento. Non sono presenti opere in galleria.';
$testo["eng"][5] = 'Sorry, the site is under maintainance. Please try later.';
$testo['ita'][6] = 'Sono presenti %d immagini';
$testo['eng'][6] = 'There are %d pictures';
$testo['ita'][7] = 'Sito in allestimento. Non ci sono immagini in questa categoria';
$testo['eng'][7] = 'Sorry, there are no pictures in this cathegory.';
$testo['ita'][8] = 'Errore: La categoria specificata non esiste';
$testo['eng'][8] = 'Error: Requested cathegory doesn\'t exist';
$testo['ita'][9] = 'Anteprima non disponibile';
$testo['eng'][9] = 'Preview not available';
$testo['ita'][10] = 'Pagina Precedente';
$testo['eng'][10] = 'Prev Page';
$testo['ita'][11] = 'Pagina Successiva';
$testo['eng'][11] = 'Next Page';

$categoria = -1;
$pagina = 0;
$n = 6;
$lang = "ita";

if (isset($_GET['pagina'])){
	$pagina = $_GET['pagina'];
}

if (isset($_GET['categoria'])){
	$categoria=$_GET['categoria'];
}

if (isset($_GET['lang'])) {
	$lang = $_GET['lang'];
}


function collegamenti($pag, $tot_pag) {
	global $lang;
	global $testo;
	global $categoria;
	echo '<div class="collegamenti">';
	if ($pag < ($tot_pag -1) ) { 
		/*Collega alla pagina successiva*/
		$p = $pag + 1;
		echo '<div class="successiva">';
		echo "\t<a href='galleria.php?categoria=$categoria&lang=$lang&pagina=$p'>";
		echo "\t\t{$testo[$lang][11]}<img src='images/freccia_dx.gif' alt='Next'/>";
		echo "\t</a>";
		echo '</div>';
	}
	if ($pag > 0 ) { 
		/*Collega alla pagina precedente*/
		$p = $pag -1;
		echo '<div class="precedente">';
		echo "\t<a href='galleria.php?categoria=$categoria&lang=$lang&pagina=$p' >";
		echo "\t\t<img src='images/freccia_sx.gif' alt='Pre' />{$testo[$lang][10]}";
		echo "\t</a>";
		echo '</div>';
	}
	echo '</div>';
}

/*****************************************************************************
 *
 * Sei nella pagina di selezione di una categoria o ne stai già 
 * sfogliando una? Mostra l'intestazione appropriata...
 *
 *
 *
 * L'id della categoria è un numero non negativo, per cui
 * se il valore di $categoria è negativo vuol dire che si sta accedendo
 * alla pagina principale della galleria, da cui si sceglie la sezione
 * da visitare
 *
 *****************************************************************************/
if ( $categoria < 0) {
	echo sprintf('<h1 id="titolo_pagina">%s</h1><p>%s</p>', $testo[$lang][1], $testo[$lang][3] );
	
	// Controlla se ci sono categorie nel database
	$link = mysql_connect($db_h, $db_u, $db_p);
	mysql_query("USE $db");
	$r = mysql_query("SELECT id, nome_$lang FROM categorie");
	$n_of_rows = mysql_num_rows($r);
	if ( $n_of_rows > 0 ) {
		
		// Nel database esistono categorie
		// Mostra i collegamenti per accedere alle stesse
		for ( $i = 0; $i < $n_of_rows; $i++){
			list($id, $nome) = mysql_fetch_array($r);
			$r2 = mysql_query("SELECT id FROM quadri WHERE id_categoria=$id");
			$n_of_images = 0;
			if ($r2) {
				$n_of_images = mysql_num_rows($r2);
			}
			$out = sprintf("
			<a class='categoria' href='galleria.php?categoria=$id&lang=$lang&pagina=$pagina'>
				<div class='categoria'>
					<img class='categoria' alt='Preview' src='$categorie_url/$id/emblema.jpeg'/>
					<h3 class='categoria'>$nome</h3>
					<p class='categoria'>{$testo[$lang][6]}</p>
				</div>
			</a>", $n_of_images);
			echo $out;
		}
	} else {
		
		// Non ci sono categorie nel database
		// Mostra un messaggio che avvisa che non ci sono categorie
		echo "<p>{$testo[$lang][5]}</p>";
	}
	mysql_close($link);

} else {
/*********************************************************************************
 * 
 * L'id della categoria è stato inviato tramite get ed è un numero maggiore di
 * zero (sempre che sia valido). Sei all'interno di una categoria, mostra le immagini che ne fanno parte
 * tenendo conto che ogni pagina contiene $n immagini
 * Pagina 1 contiene 1, 2, 3, 4, 5, 6       pagina = 0
 * Pagina 2   "  "   1+$n, 2+$n, ... 6+$n   pagina = 1
 * Pagina $p contiene 1+$n$p, 2+$n$p, ...,  pagina = $pagina
 *
 * Le immagini mostrate dipendono, poi, dal valore di $categoria
 *
 ********************************************************************************/
	$link = mysql_connect($db_h, $db_u, $db_p);
	mysql_query("USE $db");
	
	// Controlla che la categoria specificata esista
	$r = mysql_query("SELECT nome_$lang FROM categorie WHERE id=$categoria");
	
	if ($r) {
		
		// Se esiste una categoria con l'id specificato mostra il suo titolo
		$row = mysql_fetch_array($r);
		echo "<h1 id='titolo_pagina'>{$row[0]}</h1>";
		
		// Se ci sono immagin che appartengono alla categoria mostrale
		$r2 = mysql_query("SELECT id, titolo_{$lang}, anno,
							tecnica_{$lang}, altezza, larghezza FROM quadri WHERE id_categoria=$categoria ORDER BY data DESC");
		
		// La categoria contiene immagini?
		$z = mysql_num_rows($r2);
		$tot_pagine = ceil( $z / $n);
		if ( $pagina < 0 || $pagina > $tot_pagine ) {
			$pagina = 0;
		}
		if ( $z > 0 ) {
			
			// Ci sono $z immagini nella categoria specificata
			// Mostra un sottotitolo per visualizzare il numero totale di immagini nella categoria
			// Reperisci le informazioni sull'opera dal database
			// e crea l'html per ogni immagine, a seconda della pagina utilizzata
			echo sprintf($testo[$lang][2], $pagina + 1, $tot_pagine);
			
			
			// Scegli la riga in base alla pagina
			mysql_data_seek($r2, $n * $pagina);
			
			// Crea il codice per l'anteprima
			for ($i = 0; $i < $n; $i++) {
				if ($row2 = mysql_fetch_array($r2)) {
					list($id, $titolo, $anno, $tecnica, $altezza, $larghezza) = $row2;
					echo <<<EOT
<div class='anteprima'>
	<a href='$galleria_url/$id/big.jpeg'>
		<img src='$galleria_url/$id/small.jpeg' alt='{$testo[$lang][9]}'/>
	</a>
	<h3>$titolo</h3>
	<p>{$larghezza}x{$altezza}<br/>$tecnica<br/>$anno</p>
</div>
EOT;
				}
			}
			
			// Crea il codice per i collegamenti alla pagina precedente e successiva
			if ( $pagina > 0 || $pagina < ($tot_pagine -1) ) {
				collegamenti($pagina, $tot_pagine);
			}
		} else {
			
			// Non ci sono immagini nella categoria specificata
			echo "<p>{$testo[$lang][7]}</p>";
		}
		
	} else {
		
		// Se l'id specificato per la categoria non è presente nel db, mostra un
		// messaggio di errore
		echo "<p>{$testo[$lang][8]}</p>";
	}
	
	mysql_close($link);

}
?>
<hr/>
<p style="font-size: 10px;">Per accedere all'area riservata e modificare la parte dinamica
del sito <a href="area_riservata.php">fare clic qui</a></p>
